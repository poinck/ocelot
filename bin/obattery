#!/bin/bash
#
# obattery uses battery-information from /sys/class/power_supply. Currently
# only BAT0 is supported.
#
#    ^   ^
#  +-------+
#  |  o_O  |
#  |  >.<  |__/
#  +-------+
#
# ocelot by AndrÃ© Klausnitzer, CC0

source ${OCELOT_PATH}bin/outils.sh

get_battery() {
    bat_percent=0
    bat_now=$(cat /sys/class/power_supply/BAT0/energy_now)
    bat_status=$( cat /sys/class/power_supply/BAT0/status )
    bat_full=$(cat /sys/class/power_supply/BAT0/energy_full)
    bat_percent=$(( bat_now*100/bat_full ))
    bat_now_mAh=$(( bat_now/10000 ))
    bat_graph=$cdarkpurple
    bgcolor=$cdarkgrey
    bat_font=${cfont}
    bat_darkfont=${cdarkfont}
    bat_percent2=${bat_percent}
    bat_status2="BAT"
    if [[ "$bat_status" == "Charging" ]] ; then
        bat_status2="CRG"
    elif [[ "$bat_status" == "Unknown" ]] ; then
        bat_status2="PWR"
    elif [[ "$bat_status" == "Full" ]] ; then
        bat_status2="BAT"
    else
        bat_status2="BAT"
    fi

    if [[ "$bat_percent" -lt 15 ]] ; then
        #bat_percent2=100
        bgcolor=$cyellow
        bat_graph=${cdarkgrey}
        bat_font=${cdarkgrey}
        bat_darkfont=${cdarkyellow}
    fi
}

ofifo="/tmp/ocollector.fifo$OCELOT_INSTANCE"
while true ; do
    get_battery

    if [[ "${bat_percent}" -lt 10 ]] ; then
        bat_percent="_${bat_percent}"
    elif [[ "${bat_percent}" -ge 100 ]] ; then
        bat_percent="FF"
    fi
    battery="battery ^fg(#${cfont})${bat_percent}^fg(#${cdarkfont})${bat_status2} ${bgcolor} ${bat_percent2} ${bat_graph}"
    echo "[DEBUG] $battery"
    echo "$battery" > "$ofifo"

    sleep 60
done
