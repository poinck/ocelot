#!/bin/bash
#
# obattery uses battery-information from /sys/class/power_supply. Currently
# only BAT0 is supported.
#
#    ^   ^
#  +-------+
#  |  o_O  |
#  |  >.<  |__/
#  +-------+
#
# ocelot by AndrÃ© Klausnitzer, CC0

source ${OCELOT_PATH}bin/outils.sh

bat_status2="_"
bat_percent=0
bgcolor=$cdarkgrey
bat_graph=$cdarkpurple

get_battery() {
    bat_now=$(cat /sys/class/power_supply/BAT0/energy_now)
    bat_status=$( cat /sys/class/power_supply/BAT0/status )
    bat_full=$(cat /sys/class/power_supply/BAT0/energy_full)
    bat_percent=$(( bat_now*100/bat_full ))
    bat_now_mAh=$(( bat_now/10000 ))
    bat_graph2=""
    if [[ "$bat_status" == "Charging" ]] ; then
        bat_status2="C"
        bat_percent2=$bat_percent
    elif [[ "$bat_status" == "Unknown" ]] ; then
        bat_status2="N"
        bat_percent2=$bat_percent
    elif [[ "$bat_status" == "Full" ]] ; then
        bat_status2="F"
        bat_percent2=$bat_percent
    else
        bat_status2="B"
        if [[ "$bat_percent" -lt 10 ]] ; then
            bat_percent2=100
            bgcolor=$cyellow
            bat_graph=$cfont
            bat_graph2="100 $cdarkyellow"
        fi
    fi
}

ofifo="/tmp/ocollector.fifo$OCELOT_INSTANCE"
while true ; do
    get_battery

    battery="battery ^fg(#${cdarkfont})${bat_status2}_^fg(#${cfont})${bat_percent}% ${bgcolor} ${bat_percent2} ${bat_graph} ${bat_graph2}"
    echo "[DEBUG] $battery"
    echo "$battery" > "$ofifo"

    sleep 60
done
