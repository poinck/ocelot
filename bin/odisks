#!/bin/bash
#
# odisks uses output from `df` Currently
# only / and /home are supported.
#
#    ^   ^
#  +-------+
#  |  o_O  |
#  |  >.<  |__/
#  +-------+
#
# ocelot by AndrÃ© Klausnitzer, CC0

ofifo="/tmp/ocollector.fifo$OCELOT_INSTANCE"
low_color="fbf236"
high_color="fb3636"
low_bgcolor="262613"
high_bgcolor="261313"
bgcolor=${low_bgcolor}
color=${low_color}
source ${OCELOT_PATH}bin/outils.sh

get_disks() {
    disks_now=$( df --output=target,pcent / /home | tail -n 2 )

    p=0
    #echo "[DEBUG] disks_now = ${disks_now}"
    for disk in ${disks_now} ; do
        p=$(( p+1 ))
        if [[ "$p" -eq 2 ]] ; then
            disk_root_percent=${disk%%%*}
            color=$( get_hex_color "${low_color}" "${high_color}" "${disk_root_percent}" )
            bgcolor=$( get_hex_color "${low_bgcolor}" "${high_bgcolor}" "${disk_root_percent}" )
            #echo "[DEBUG] color = $color"
            disks="disk_root ^fg(#ffffff)/ ${bgcolor} ${disk_root_percent} ${color}"
            echo "[DEBUG] $disks"
            echo "$disks" > "$ofifo"
        elif [[ "$p" -eq 4 ]] ; then
            disk_home_percent=${disk%%%*}
            color=$( get_hex_color "${low_color}" "${high_color}" "${disk_home_percent}" )
            bgcolor=$( get_hex_color "${low_bgcolor}" "${high_bgcolor}" "${disk_home_percent}" )
            #echo "[DEBUG] color = $color"
            disks="disk_home ^fg(#ffffff)/home ${bgcolor} ${disk_home_percent} ${color}"
            echo "[DEBUG] $disks"
            echo "$disks" > "$ofifo"
        fi
        #echo "[DEBUG] $p -> $disk"
    done
}

while true ; do
    get_disks

    # TODO  ocollector-api
    # - space seperated parameters:
    #   <type> <label> [<bgcolor> [<percent> <color>]* ..]
    # - "type" is needed for ordering elements in ocollector
    # - "label" is text that is displayed
    # - "bgcolor" is background color of element
    # - font-color should be set with dzen2-syntax inside "label"
    # - "percent" is value for grapical represention
    # - "color" is color for graph

    sleep 600
done
