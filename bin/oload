#!/bin/bash
#
# oload does too much: load 15, 5, 1; net-usage; critical cpu-temperature;
# uptime; ..
#
#    ^   ^
#  +-------+
#  |  o_O  |
#  |  >.<  |__/
#  +-------+
#
# ocelot by AndrÃ© Klausnitzer, CC0

source ${OCELOT_PATH}bin/outils.sh

remove_leading_zeros() {
    local s="$1"
    local number=0

    #re='^[0]+(.*)'
    #[[ "$s" =~ $re ]] && number="${BASH_REMATCH[1]}" || number="$s"
        # XXX   see new implementation below, implementation above works, but is
        # maybe slower at runtime.

    # force decimal (base 10), side-effect: leading zeros will be removed;
    # does not evaluate wether this is a number
    number=$(( 10#$s ))

    echo "$number"
}

get_load() {
    content=""

    # get virtual cpu count and loadavg from proc-filesystem
    proc_cpuinfo_processor=$( cat /proc/cpuinfo | grep processor | tail -n 1 )
    if [[ -z "$proc_cpuinfo_processor" ]] ; then
        proc_cpuinfo_processor=1
    fi
    proc_loadavg=$( cat /proc/loadavg )

    local i=0
    for loadavg in $proc_loadavg ; do
        #echo "[DEBUG] loadavg = $loadavg"
        i=$(( i+1 ))
        loadavg=${loadavg/./}
        if [[ "$i" -eq 1 ]] ; then
            load1="$loadavg"
        elif [[ "$i" -eq 2 ]] ; then
            load5="$loadavg"
        elif [[ "$i" -eq 3 ]] ; then
            load15="$loadavg"
        fi
    done
    load_max=${proc_cpuinfo_processor#*: }
    load_max=$(( load_max+1 ))
    load_warning=$(( load_max*100 ))
    load_max=$(( load_max*200 ))
    #echo "[DEBUG] load1 = $( remove_leading_zeros "$load1" )"
    #echo "[DEBUG] load1 = $load1"
    load1=$( remove_leading_zeros "$load1" )
    load5=$( remove_leading_zeros "$load5" )
    load15=$( remove_leading_zeros "$load15" )
    load1_pixel=$(( load1*59*SCALE/load_max ))
    load5_pixel=$(( load5*59*SCALE/load_max ))
    load15_pixel=$(( load15*59*SCALE/load_max ))
    [[ "$load1" -gt "$load_warning" ]] && color1="#ffeb00" || color1="#008000"
    [[ "$load5" -gt "$load_warning" ]] && color5="#ff9600" || color5="#529c00"
    [[ "$load15" -gt "$load_warning" ]] && color15="#ff0000" || color15="#b5d400"

    #echo "[DEBUG] $load1,$load1_pixel $load5,$load5_pixel $load15,$load15_pixel $load_max"
    content="^ib(1)^pa(${_BTB};${_BTM})^fg($color1)^r(${load1_pixel}x${_BP})"
    content+="^ib(1)^pa(${_BTB};${_BTM})^fg($color5)^r(${load5_pixel}x${_BP})"
    content+="^ib(1)^pa(${_BTB};${_BTM})^fg($color15)^r(${load15_pixel}x${_BP})"
}


ofifo="/tmp/ocollector.fifo$OCELOT_INSTANCE"
while true ; do
    get_load
    load="load ${load_content}"
    echo "[DEBUG] $load"
    echo "$load" > "$ofifo"

    sleep 14
done
