#!/bin/bash
#
# otime provides day of the week, week number, time, day of month and month
# for the ocelot side-panel
#
#    ^   ^
#  +-------+
#  |  o_O  |
#  |  >.<  |__/
#  +-------+
#
# ocelot by AndrÃ© Klausnitzer, CC0

source ${OCELOT_PATH}bin/outils.sh

get_graph() {
    g16=$1 # 16th part of side-panel element width

    graph=""
    for (( ii=1 ; ii<=g16 ; ii=ii+1 )) ; do
        graph+=" 100 $cgrey"
        #echo "[DEBUG] ii=$ii"
    done

    echo -e "$graph"
}

otime_content=""
get_otime() {
    day=$( date '+%A' )
    #echo "[DEBUG] day = '$day'"
    day=${day:0:3}
    #echo "[DEBUG] day = '$day'"
    day=${day^^*}
    #echo "[DEBUG] day = '$day'"

    hour=$(date '+%-H')
    hour_graph=$( get_graph "$(( hour*16/24 ))" )
    hour_percent=$(( hour*100/24 ))

    minute=$(date '+%-M')
    minute_graph=$( get_graph "$(( minute*16/60 ))" )
    minute_percent=$(( minute*100/60 ))

    day_in_month=$(date '+%-d')
    month=$(date '+%b')
    month=${month:0:3}
    #echo "[DEBUG] month = '$month'"
    month=${month^^*}
    #echo "[DEBUG] month = '$month'"

    year=$(date '+%Y')
    year2=${year:0:2}
    year4=${year:2:2}

    otime_hour="time_hour ^fg(#${cdarkfont})T_^fg(#${cfont})${hour} ${cdarkgrey} ${hour_percent} $cdarkblue ${hour_graph}"
    otime_minute="time_minute ^fg(#${cdarkfont})__^fg(#${cfont})${minute} ${cdarkgrey} ${minute_percent} $cpurple ${minute_graph}"
    otime_day="day ^fg(#${cdarkerfont})D_^fg(#${cdarkfont})${day} $cdarkgrey"
    otime_day_in_month="day_in_month ^fg(#${cdarkgrey})__^fg(#${cfont})${day_in_month} $cdarkgrey"
    otime_month="month ^fg(#${cdarkgrey})__^fg(#${cfont})${month} $cdarkgrey"
    otime_year="year ^fg(#${cdarkerfont})${year2}^fg(#${cdarkfont})${year4} $cdarkgrey"
    otime_week="week ^fg(#${cdarkfont})W_^fg(#${cfont})$(date '+%-W') $cdarkgrey"
}

ofifo="/tmp/ocollector.fifo$OCELOT_INSTANCE"
while true ; do
    get_otime

    #echo "[DEBUG] $otime_day"
    #echo "[DEBUG] $otime_week"
    echo "$otime_hour" > "$ofifo"
    echo "$otime_minute" > "$ofifo"
    echo "$otime_day" > "$ofifo"
    echo "$otime_day_in_month" > "$ofifo"
    echo "$otime_month" > "$ofifo"
    echo "$otime_year" > "$ofifo"
    echo "$otime_week" > "$ofifo"

    second=$( date '+%-S' )
    #echo "[DEBUG] second=$second"
    delay=$(( 60-second ))
    #echo "[DEBUG] delay=${delay}"

    sleep "$delay"
done
