#!/bin/bash
#
# oupdates looks for Gentoo security updates using `glsa-check`
#
#    ^   ^
#  +-------+
#  |  o_O  |
#  |  >.<  |__/
#  +-------+
#
# ocelot by AndrÃ© Klausnitzer, CC0

ofifo="/tmp/ocollector.fifo$OCELOT_INSTANCE"

echo "[DEBUG] ocelot_path = '$OCELOT_PATH'"
source ${OCELOT_PATH}bin/outils.sh

# check security updates for gentoo
updates_available_list=$( glsa-check -n -q -l affected )
rc=$?
if [[ "${rc}" -eq 0 ]] ; then
    updates_available=$( echo "$updates_available_list" | wc -l )
    updates_available_empty=$( echo "$updates_available_list" | wc -w )
else
    # check security updates for centos
    updates_available_list=$( yum check-update --security )
    rc_yum=$?
    if [[ "${rc_yum}" -gt 0 ]] ; then
        updates_available=$( echo "$updates_available_list" | wc -l )
        updates_available_empty=$( echo "$updates_available_list" | wc -w )
    else
        updates_available=0
        updates_available_empty=0
    fi
fi

if [[ "$updates_available" -le 1 ]] && [[ "$updates_available_empty" -le 1 ]] ; then
    updates_available="^fg(#$cdarkerfont)___^fg(#$cdarkerfont)SEC $cdarkgrey"
else
    if [[ "${updates_available}" -lt 10 ]] ; then
        updates_available="__${updates_available}"
    elif [[ "${updates_available}" -lt 100 ]] ; then
        updates_available="_${updates_available}"
    fi
    updates_available="^fg(#$cfont)${updates_available}^fg(#${cdarkfont})SEC ${cgrey} 100 ${corange}"
fi

updates="updates ${updates_available}"
#echo -e "[DEBUG] updates empty = $updates_available_empty"
echo -e "update list:\n$updates_available_list"
echo "[DEBUG] $updates"
echo "$updates" > "$ofifo"
